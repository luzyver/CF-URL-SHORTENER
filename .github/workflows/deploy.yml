name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  WORKER_NAME: cf-url-shortener
  KV_NAMESPACE_NAME: LINKS

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check and Create KV Namespace
        id: kv_setup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          KV_LIST=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          KV_ID=$(echo $KV_LIST | jq -r ".result[] | select(.title==\"${WORKER_NAME}-${KV_NAMESPACE_NAME}\") | .id")
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            CREATE_RESPONSE=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "{\"title\":\"${WORKER_NAME}-${KV_NAMESPACE_NAME}\"}")
            
            KV_ID=$(echo $CREATE_RESPONSE | jq -r '.result.id')
            
            if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
              echo $CREATE_RESPONSE | jq .
              exit 1
            fi
          fi
          
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT

      - name: Update wrangler.toml
        run: |
          KV_ID="${{ steps.kv_setup.outputs.kv_id }}"
          TURNSTILE_SITE_KEY="${{ secrets.TURNSTILE_SITE_KEY }}"
          
          sed -i "s/id = \"your-kv-namespace-id-here\"/id = \"$KV_ID\"/" wrangler.toml
          sed -i "s/id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          
          if [ -n "$TURNSTILE_SITE_KEY" ]; then
            sed -i "s/TURNSTILE_SITE_KEY = \"\"/TURNSTILE_SITE_KEY = \"$TURNSTILE_SITE_KEY\"/" wrangler.toml
          fi

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy

      - name: Set Worker Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "${{ secrets.ADMIN_API_KEY }}" ]; then
            echo "${{ secrets.ADMIN_API_KEY }}" | npx wrangler secret put ADMIN_API_KEY
          fi
          
          if [ -n "${{ secrets.TURNSTILE_SECRET_KEY }}" ]; then
            echo "${{ secrets.TURNSTILE_SECRET_KEY }}" | npx wrangler secret put TURNSTILE_SECRET_KEY
          fi
