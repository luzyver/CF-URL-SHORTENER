name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  WORKER_NAME: cf-url-shortener
  KV_NAMESPACE_NAME: LINKS

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check and Create KV Namespace
        id: kv_setup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Checking existing KV namespaces..."
          
          # List existing KV namespaces
          KV_LIST=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          # Check if namespace already exists
          KV_ID=$(echo $KV_LIST | jq -r ".result[] | select(.title==\"${WORKER_NAME}-${KV_NAMESPACE_NAME}\") | .id")
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "KV namespace not found. Creating new namespace..."
            
            # Create new KV namespace
            CREATE_RESPONSE=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "{\"title\":\"${WORKER_NAME}-${KV_NAMESPACE_NAME}\"}")
            
            KV_ID=$(echo $CREATE_RESPONSE | jq -r '.result.id')
            
            if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
              echo "Failed to create KV namespace"
              echo $CREATE_RESPONSE | jq .
              exit 1
            fi
            
            echo "KV namespace created with ID: $KV_ID"
          else
            echo "KV namespace already exists with ID: $KV_ID"
          fi
          
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT

      - name: Update wrangler.toml with KV ID
        run: |
          KV_ID="${{ steps.kv_setup.outputs.kv_id }}"
          echo "Updating wrangler.toml with KV ID: $KV_ID"
          
          # Update the KV namespace ID in wrangler.toml
          sed -i "s/id = \"your-kv-namespace-id-here\"/id = \"$KV_ID\"/" wrangler.toml
          sed -i "s/id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          
          echo "Updated wrangler.toml:"
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Deploying worker..."
          npx wrangler deploy

      - name: Set Worker Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Setting worker secrets..."
          
          # Set ADMIN_API_KEY secret if provided
          if [ -n "${{ secrets.ADMIN_API_KEY }}" ]; then
            echo "${{ secrets.ADMIN_API_KEY }}" | npx wrangler secret put ADMIN_API_KEY
            echo "ADMIN_API_KEY secret set"
          else
            echo "ADMIN_API_KEY secret not provided in GitHub secrets"
          fi

      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "Deployment Complete!"
          echo "============================================"
          echo "Worker Name: ${{ env.WORKER_NAME }}"
          echo "KV Namespace ID: ${{ steps.kv_setup.outputs.kv_id }}"
          echo "============================================"

